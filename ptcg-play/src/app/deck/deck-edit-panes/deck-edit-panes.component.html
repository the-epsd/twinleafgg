<dnd-preview [allBackends]="true">
  <ng-template let-type let-item="item">
    <ng-container [ngSwitch]="type">
      <div class="ptcg-card" *ngSwitchCase="'DECK_CARD'">
        <img class="ptcg-card-preview" [ptcgImageCache]="item.data.scanUrl">
      </div>
    </ng-container>
  </ng-template>
</dnd-preview>

<cdk-virtual-scroll-viewport *ngIf="showLibrary" class="ptcg-deck-edit-pane" [dropTarget]="libraryTarget"
  ptcgDropHighlight [ptcgDropHighlightVisible]="libraryHighlight$ | async" [itemSize]="77" minBufferPx="900"
  maxBufferPx="1800">
  <ptcg-deck-card *cdkVirtualFor="let card of (cards | filterCards: toolbarFilter)" [dndSortableExternal]="card.spec"
    #ext="dndSortableExternal" [source]="ext.source" (cardClick)="onLibraryCardClick(card)"
    (cardSelected)="onCardSelectedOnDialog(render.data, $event.card, $event.action)" (addCard)="addCardToDeck(card)"
    (removeCard)="removeCardFromDeck(card)" (favoriteToggled)="refreshLibrary()" [card]="card" [isLibraryCard]="true">
  </ptcg-deck-card>
</cdk-virtual-scroll-viewport>

<div class="ptcg-deck-edit-pane-secondary" [dropTarget]="deckTarget" ptcgDropHighlight
  [ptcgDropHighlightVisible]="deckHighlight$ | async">
  <button mat-icon-button class="library-toggle" (click)="toggleLibrary()"
    [matTooltip]="(showLibrary ? 'Hide' : 'Show') + ' Card Library'" [disabled]="disabled">
    <mat-icon>{{ showLibrary ? 'chevron_left' : 'chevron_right' }}</mat-icon>
  </button>
  <div #deckPane class="deck-pane-container">
    <dnd-sortable-list listId="CARD_LIBRARY_LIST" hoverTrigger="fixed" [children]="tempList" [spec]="deckSpec">
      <ng-template dndSortableTemplate let-context>
        <div class="deck-card-inline" [attr.data-card-fullname]="context?.card?.fullName">
          <ptcg-deck-card [dndSortableRender]="context" #render="dndSortableRender"
            [ptcgCardPlaceholder]="render.isDragging$" [source]="render.source" showCardCount="true"
            (countClick)="setCardCount(render.data)"
            (cardSelected)="onCardSelectedOnDialog(render.data, $event.card, $event.action)"
            (addCard)="addCardToDeck(render.data)" (removeCard)="removeCardFromDeck(render.data)" [card]="render.data"
            [customArtworkUrl]="resolveArtworkUrlFor(render.data.card)" [artworksContext]="null">
          </ptcg-deck-card>
          <!-- <div class="artwork-inline" *ngIf="!disabled">
            <select class="artwork-select-under-card" [value]="getSelectedArtworkIdString(render.data.card.fullName)"
              (change)="onArtworkSelect(render.data.card.fullName, $event.target.value)">
              <option value="" [selected]="getSelectedArtworkId(render.data.card.fullName) === null">Default</option>
              <option *ngFor="let a of (unlockedArtworks | artworksFor:render.data.card)" [value]="a.id"
                [selected]="getSelectedArtworkId(render.data.card.fullName) === a.id">{{ a.name }}
              </option>
            </select>
          </div> -->
        </div>
      </ng-template>
    </dnd-sortable-list>
    <svg #evolutionArrows class="evolution-arrows-overlay" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrowhead" markerWidth="3" markerHeight="3" refX="1.5" refY="1.5" orient="auto">
          <polygon points="0,0 3,1.5 0,3" fill="#FFD700" stroke="#2d3748" stroke-width="0" />
        </marker>
      </defs>
    </svg>
  </div>
  <div class="deck-validity-container">
    <ptcg-deck-validity [deck]="tempList"></ptcg-deck-validity>
  </div>
</div>
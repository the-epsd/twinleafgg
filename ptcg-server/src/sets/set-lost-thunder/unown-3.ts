// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, TrainerType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, StateUtils, GameError, GameMessage } from '../../game';
import { TrainerCard } from '../../game/store/card/trainer-card';
import { Effect } from '../../game/store/effects/effect';
import { endGame } from '../../game/store/effect-reducers/check-effect';
import { WAS_POWER_USED, IS_ABILITY_BLOCKED, ABILITY_USED } from '../../game/store/prefabs/prefabs';

export class Unown3 extends PokemonCard {
  public stage: Stage = Stage.BASIC;
  public cardType: CardType = P;
  public hp: number = 60;
  public weakness = [{ type: P }];
  public retreat = [C];

  public powers = [{
    name: 'MISSING',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'Once during your turn (before your attack), if this Pokémon is your Active Pokémon, and if your opponent has 12 or more Supporter cards in the Lost Zone, you may use this Ability. If you do, you win this game.'
  }];

  public attacks = [
    {
      name: 'Hidden Power',
      cost: [P],
      damage: 10,
      text: ''
    }
  ];

  public set: string = 'LOT';
  public setNumber: string = '92';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Unown';
  public fullName: string = 'Unown LOT 92';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: MISSING
    // Ref: set-breakpoint/slowbro.ts (Walk-Off Homer - endGame win condition)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        throw new GameError(GameMessage.BLOCKED_BY_EFFECT);
      }

      // Must be Active Pokemon
      if (player.active.getPokemonCard() !== this) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      // Count Supporter cards in opponent's Lost Zone
      const supporterCount = opponent.lostzone.cards.filter(c =>
        c instanceof TrainerCard && c.trainerType === TrainerType.SUPPORTER
      ).length;

      if (supporterCount < 12) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      ABILITY_USED(player, this);

      // Win the game!
      state = endGame(store, state, player.id);
    }

    return state;
  }
}

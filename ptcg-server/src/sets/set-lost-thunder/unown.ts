// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, GameError, GameMessage } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { endGame } from '../../game/store/effect-reducers/check-effect';
import { WAS_POWER_USED, IS_ABILITY_BLOCKED } from '../../game/store/prefabs/prefabs';

export class Unown extends PokemonCard {
  public stage: Stage = Stage.BASIC;
  public cardType: CardType = P;
  public hp: number = 60;
  public weakness = [{ type: P }];
  public retreat = [C];

  public powers = [  {
    name: 'DAMAGE',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'Once during your turn (before your attack), if this Pokémon is your Active Pokémon, and if there are 66 or more damage counters on your Benched Pokémon, you may use this Ability. If you do, you win this game.'
  }];

  public attacks = [
    {
      name: 'Hidden Power',
      cost: [P],
      damage: 10,
      text: ''
    }
  ];

  public set: string = 'LOT';
  public setNumber: string = '90';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Unown';
  public fullName: string = 'Unown LOT';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: DAMAGE
    // Ref: set-breakpoint/slowbro.ts (Walk-Off Homer - endGame win condition)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        throw new GameError(GameMessage.BLOCKED_BY_EFFECT);
      }

      // Must be Active Pokemon
      if (player.active.getPokemonCard() !== this) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      // Count damage counters on benched Pokemon
      let damageCounters = 0;
      player.bench.forEach(benchSlot => {
        if (benchSlot.cards.length > 0) {
          damageCounters += benchSlot.damage / 10;
        }
      });

      if (damageCounters < 66) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      // Win the game
      state = endGame(store, state, player.id);
    }

    return state;
  }
}

// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag, SuperType } from '../../game/store/card/card-types';
import { Card, CardList, ChooseCardsPrompt, GameMessage, StoreLike, State, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { WAS_ATTACK_USED, BLOCK_IF_GX_ATTACK_USED, SHUFFLE_DECK } from '../../game/store/prefabs/prefabs';
import { HEAL_X_DAMAGE_FROM_THIS_POKEMON, YOUR_OPPPONENTS_ACTIVE_POKEMON_IS_NOW_CONFUSED } from '../../game/store/prefabs/attack-effects';

export class PalossandGx extends PokemonCard {
  public tags = [CardTag.POKEMON_GX];
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Sandygast';
  public cardType: CardType = F;
  public hp: number = 210;
  public weakness = [{ type: G }];
  public retreat = [C, C, C, C];

  public attacks = [
    {
      name: 'Eerie Light',
      cost: [F, C, C],
      damage: 60,
      text: 'Your opponent\'s Active Pokémon is now Confused.'
    },
    {
      name: 'Absorb Life',
      cost: [F, F, C, C],
      damage: 100,
      text: 'Heal 20 damage from this Pokémon.'
    },
    {
      name: 'Sandy Fear-GX',
      cost: [F, F, C, C],
      damage: 60,
      damageCalculation: 'x' as 'x',
      text: 'Look at the top 13 cards of your opponent\'s deck and discard any number of Pokémon you find there. This attack does 60 damage for each card you discarded in this way. Your opponent shuffles the other cards back into their deck. (You can\'t use more than 1 GX attack in a game.)'
    }
  ];

  public set: string = 'CES';
  public setNumber: string = '82';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Palossand-GX';
  public fullName: string = 'Palossand-GX CES';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Eerie Light
    // Ref: set-ultra-prism/salazzle.ts (Panic Poison)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      YOUR_OPPPONENTS_ACTIVE_POKEMON_IS_NOW_CONFUSED(store, state, effect);
    }

    // Attack 2: Absorb Life
    // Ref: set-forbidden-light/gogoat.ts (Milk Drink)
    if (WAS_ATTACK_USED(effect, 1, this)) {
      HEAL_X_DAMAGE_FROM_THIS_POKEMON(20, effect, store, state);
    }

    // Attack 3: Sandy Fear-GX
    // Ref: set-roaring-skies/jirachi.ts (Diminutive Desire - look at top cards, choose, shuffle back)
    if (WAS_ATTACK_USED(effect, 2, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      BLOCK_IF_GX_ATTACK_USED(player);
      player.usedGX = true;

      if (opponent.deck.cards.length === 0) {
        return state;
      }

      const deckTop = new CardList();
      const count = Math.min(13, opponent.deck.cards.length);
      opponent.deck.moveTo(deckTop, count);

      // Check if there are any Pokemon in the top cards
      const hasPokemon = deckTop.cards.some(c => c.superType === SuperType.POKEMON);

      if (!hasPokemon) {
        // No Pokemon found, put everything back and shuffle
        deckTop.moveTo(opponent.deck);
        SHUFFLE_DECK(store, state, opponent);
        return state;
      }

      return store.prompt(state, new ChooseCardsPrompt(
        player,
        GameMessage.CHOOSE_CARD_TO_DISCARD,
        deckTop,
        { superType: SuperType.POKEMON },
        { min: 0, allowCancel: false }
      ), selected => {
        const cards = selected || [];
        effect.damage = 60 * cards.length;

        // Discard selected Pokemon
        cards.forEach((card: Card) => {
          deckTop.moveCardTo(card, opponent.discard);
        });

        // Put remaining cards back into opponent's deck
        deckTop.moveTo(opponent.deck);
        SHUFFLE_DECK(store, state, opponent);
      });
    }

    return state;
  }
}

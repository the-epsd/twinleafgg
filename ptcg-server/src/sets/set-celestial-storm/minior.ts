// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { GameError, GameMessage, PowerType, StoreLike, State, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { ApplyWeaknessEffect, AfterDamageEffect } from '../../game/store/effects/attack-effects';
import { WAS_ATTACK_USED, WAS_POWER_USED, IS_ABILITY_BLOCKED, USE_ABILITY_ONCE_PER_TURN, ABILITY_USED, REMOVE_MARKER_AT_END_OF_TURN } from '../../game/store/prefabs/prefabs';

export class Minior extends PokemonCard {
  public stage: Stage = Stage.BASIC;
  public cardType: CardType = F;
  public hp: number = 90;
  public weakness = [{ type: G }];
  public retreat = [C, C];

  public powers = [{
    name: 'Falling Star',
    useFromHand: true,
    powerType: PowerType.ABILITY,
    text: 'Once during your turn (before your attack), if this Pokémon is in your hand and your Bench isn\'t full, you may move your Active Pokémon to your Bench and play this Pokémon as your new Active Pokémon.'
  }];

  public attacks = [
    {
      name: 'Swift',
      cost: [F],
      damage: 30,
      text: 'This attack\'s damage isn\'t affected by Weakness, Resistance, or any other effects on your opponent\'s Active Pokémon.'
    }
  ];

  public set: string = 'CES';
  public setNumber: string = '83';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Minior';
  public fullName: string = 'Minior CES';

  public readonly FALLING_STAR_MARKER = 'MINIOR_FALLING_STAR_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Falling Star
    // Ref: set-twilight-masquerade/palafin.ts (swap from hand pattern)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        throw new GameError(GameMessage.BLOCKED_BY_EFFECT);
      }

      // Must be in hand
      if (!player.hand.cards.includes(this)) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      // Bench must not be full
      const benchSlots = player.bench.filter(b => b.cards.length === 0);
      if (benchSlots.length === 0) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      USE_ABILITY_ONCE_PER_TURN(player, this.FALLING_STAR_MARKER, this);
      ABILITY_USED(player, this);

      // Move active to first empty bench slot
      const emptySlot = benchSlots[0];
      player.active.moveTo(emptySlot);
      player.active.clearEffects();

      // Play Minior from hand as new active
      player.hand.moveCardTo(this, player.active);
      player.active.pokemonPlayedTurn = state.turn;
    }

    REMOVE_MARKER_AT_END_OF_TURN(effect, this.FALLING_STAR_MARKER, this);

    // Attack 1: Swift
    // Ref: set-next-destinies/starmie.ts (Swift)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      const applyWeakness = new ApplyWeaknessEffect(effect, 30);
      store.reduceEffect(state, applyWeakness);

      effect.damage = 0;

      opponent.active.damage += 30;
      const afterDamage = new AfterDamageEffect(effect, 30);
      state = store.reduceEffect(state, afterDamage);
    }

    return state;
  }
}

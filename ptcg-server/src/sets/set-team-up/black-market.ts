// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { TrainerType, CardType, CardTag } from '../../game/store/card/card-types';
import { StoreLike, State, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { KnockOutEffect } from '../../game/store/effects/game-effects';
import { CheckPokemonTypeEffect, CheckProvidedEnergyEffect } from '../../game/store/effects/check-effects';

export class BlackMarket extends TrainerCard {
  public trainerType: TrainerType = TrainerType.STADIUM;
  public tags = [CardTag.PRISM_STAR];
  public set: string = 'TEU';
  public setNumber: string = '134';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Black Market \u25C7';
  public fullName: string = 'Black Market \u25C7 TEU';
  public text: string = 'When a Darkness Pok\u00e9mon (yours or your opponent\'s) that has any [D] Energy attached to it is Knocked Out by damage from an opponent\'s attack, that player takes 1 fewer Prize card. Whenever any player plays an Item or Supporter card from their hand, prevent all effects of that card done to this Stadium card. \u25C7 (Prism Star) Rule: You can\'t have more than 1 \u25C7 card with the same name in your deck. If a \u25C7 card would go to the discard pile, put it in the Lost Zone instead.';

  // Ref: set-team-up/black-market-prism-star.ts (Black Market Prism Star - existing implementation)
  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    if (effect instanceof KnockOutEffect && StateUtils.getStadiumCard(state) === this) {
      const player = effect.player;

      // Check if the Pokemon is Dark type
      const checkPokemonTypeEffect = new CheckPokemonTypeEffect(effect.target);
      store.reduceEffect(state, checkPokemonTypeEffect);
      const isDarkPokemon = checkPokemonTypeEffect.cardTypes.includes(CardType.DARK);

      // Check if the Pokemon has any [D] Energy attached
      const checkProvidedEnergyEffect = new CheckProvidedEnergyEffect(player, effect.target);
      store.reduceEffect(state, checkProvidedEnergyEffect);
      const energyMap = checkProvidedEnergyEffect.energyMap;
      const hasDarknessEnergy = StateUtils.checkEnoughEnergy(energyMap, [CardType.DARK]);

      if (isDarkPokemon && hasDarknessEnergy) {
        effect.prizeCount -= 1;
      }
    }

    return state;
  }
}

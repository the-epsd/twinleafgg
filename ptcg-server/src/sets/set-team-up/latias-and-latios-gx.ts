// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag, SuperType, EnergyType } from '../../game/store/card/card-types';
import { AttachEnergyPrompt, EnergyCard, GameMessage, PlayerType, SlotType, StoreLike, State, StateUtils } from '../../game';
import { AbstractAttackEffect } from '../../game/store/effects/attack-effects';
import { CheckProvidedEnergyEffect } from '../../game/store/effects/check-effects';
import { Effect } from '../../game/store/effects/effect';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { WAS_ATTACK_USED, BLOCK_IF_GX_ATTACK_USED } from '../../game/store/prefabs/prefabs';
import { DISCARD_X_ENERGY_FROM_THIS_POKEMON } from '../../game/store/prefabs/costs';

export class LatiasAndLatiosGx extends PokemonCard {
  public tags = [CardTag.TAG_TEAM, CardTag.POKEMON_GX];
  public stage: Stage = Stage.BASIC;
  public cardType: CardType = N;
  public hp: number = 250;
  public weakness = [{ type: Y }];
  public retreat = [C];

  public readonly AERO_UNIT_MARKER = 'LATIAS_LATIOS_GX_AERO_UNIT_MARKER';
  public readonly CLEAR_AERO_UNIT_MARKER = 'LATIAS_LATIOS_GX_CLEAR_AERO_UNIT_MARKER';

  public attacks = [
    {
      name: 'Buster Purge',
      cost: [W, P, P, C],
      damage: 240,
      text: 'Discard 3 Energy from this Pokémon.'
    },
    {
      name: 'Aero Unit-GX',
      cost: [P],
      damage: 0,
      text: 'Attach 5 basic Energy cards from your discard pile to your Pokémon in any way you like. If this Pokémon has at least 1 extra Energy attached to it (in addition to this attack\'s cost), prevent all effects of attacks, including damage, done to it during your opponent\'s next turn. (You can\'t use more than 1 GX attack in a game.)'
    }
  ];

  public set: string = 'TEU';
  public setNumber: string = '113';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Latias & Latios-GX';
  public fullName: string = 'Latias & Latios-GX TEU';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Buster Purge
    // Ref: set-lost-thunder/stunfisk.ts (DISCARD_X_ENERGY_FROM_THIS_POKEMON)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      DISCARD_X_ENERGY_FROM_THIS_POKEMON(store, state, effect, 3);
    }

    // Attack 2: Aero Unit-GX
    // Refs: set-lost-thunder/sceptile-gx.ts (GX attack), set-ultra-prism/purugly.ts (prevent all effects marker)
    if (WAS_ATTACK_USED(effect, 1, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      BLOCK_IF_GX_ATTACK_USED(player);
      player.usedGX = true;

      // Check if this Pokemon has extra energy beyond the 1 [P] cost
      const checkEnergy = new CheckProvidedEnergyEffect(player, player.active);
      store.reduceEffect(state, checkEnergy);
      const totalEnergy = checkEnergy.energyMap.reduce((sum, em) => sum + em.provides.length, 0);
      const hasExtraEnergy = totalEnergy >= 2;

      // Attach up to 5 basic Energy from discard
      const basicEnergyInDiscard = player.discard.cards.filter(c =>
        c instanceof EnergyCard && c.energyType === EnergyType.BASIC
      );

      if (basicEnergyInDiscard.length > 0) {
        const maxAttach = Math.min(5, basicEnergyInDiscard.length);
        state = store.prompt(state, new AttachEnergyPrompt(
          player.id,
          GameMessage.ATTACH_ENERGY_CARDS,
          player.discard,
          PlayerType.BOTTOM_PLAYER,
          [SlotType.ACTIVE, SlotType.BENCH],
          { superType: SuperType.ENERGY, energyType: EnergyType.BASIC },
          { allowCancel: false, min: maxAttach, max: 5 }
        ), transfers => {
          transfers = transfers || [];
          for (const transfer of transfers) {
            const target = StateUtils.getTarget(state, player, transfer.to);
            player.discard.moveCardTo(transfer.card, target);
          }
        });
      }

      // If extra energy, set prevention markers
      if (hasExtraEnergy) {
        player.active.marker.addMarker(this.AERO_UNIT_MARKER, this);
        opponent.marker.addMarker(this.CLEAR_AERO_UNIT_MARKER, this);
      }
    }

    // Prevent all effects of attacks including damage
    if (effect instanceof AbstractAttackEffect && effect.target.cards.includes(this)) {
      const pokemonCard = effect.target.getPokemonCard();
      if (pokemonCard !== this) {
        return state;
      }

      if (!effect.target.marker.hasMarker(this.AERO_UNIT_MARKER, this)) {
        return state;
      }

      const player = StateUtils.findOwner(state, effect.target);
      const attacker = StateUtils.findOwner(state, effect.source);

      if (player === attacker) {
        return state;
      }

      effect.preventDefault = true;
    }

    // Cleanup at end of opponent's turn
    if (effect instanceof EndTurnEffect
      && effect.player.marker.hasMarker(this.CLEAR_AERO_UNIT_MARKER, this)) {
      effect.player.marker.removeMarker(this.CLEAR_AERO_UNIT_MARKER, this);
      const opponent = StateUtils.getOpponent(state, effect.player);
      opponent.forEachPokemon(PlayerType.TOP_PLAYER, cardList => {
        cardList.marker.removeMarker(this.AERO_UNIT_MARKER, this);
      });
    }

    return state;
  }
}

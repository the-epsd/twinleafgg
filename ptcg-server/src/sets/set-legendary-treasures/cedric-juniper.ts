// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { TrainerType, SuperType } from '../../game/store/card/card-types';
import { StoreLike, State, StateUtils, GameMessage, GameError, SelectPrompt, CardList, ChooseCardsPrompt, ShowCardsPrompt } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { WAS_TRAINER_USED } from '../../game/store/prefabs/trainer-prefabs';
import { DRAW_CARDS } from '../../game/store/prefabs/prefabs';
import { PokemonCard } from '../../game/store/card/pokemon-card';

export class CedricJuniper extends TrainerCard {
  public trainerType: TrainerType = TrainerType.SUPPORTER;
  public set: string = 'LTR';
  public setNumber: string = '110';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Cedric Juniper';
  public fullName: string = 'Cedric Juniper LTR';
  public text: string = 'Put a Pokémon from your hand face down in front of you and tell your opponent its name. Your opponent guesses the height of that Pokémon. Reveal that Pokémon. If your opponent guessed right, he or she draws 3 cards. If your opponent guessed wrong, you draw 3 cards. Return the Pokémon to your hand. (You can\'t choose a Pokémon that doesn\'t have the height printed on the card.) You may play only 1 Supporter card during your turn (before your attack).';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Refs: set-surging-sparks/tyme.ts (hidden Pokemon guessing flow), set-rebel-clash/dan.ts (opponent-choice branch)
    if (WAS_TRAINER_USED(effect, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      if (player.supporterTurn > 0) {
        throw new GameError(GameMessage.SUPPORTER_ALREADY_PLAYED);
      }

      const hasPokemonInHand = player.hand.cards.some(c =>
        c instanceof PokemonCard
      );

      if (!hasPokemonInHand) {
        throw new GameError(GameMessage.CANNOT_PLAY_THIS_CARD);
      }

      player.hand.moveCardTo(effect.trainerCard, player.supporter);

      const selectedPokemon = new CardList();
      store.prompt(state, new ChooseCardsPrompt(
        player,
        GameMessage.CHOOSE_CARD_TO_HAND,
        player.hand,
        { superType: SuperType.POKEMON },
        { min: 1, max: 1, allowCancel: false }
      ), selected => {
        const cards = selected || [];
        if (cards.length === 0) {
          player.supporter.moveCardTo(effect.trainerCard, player.discard);
          return;
        }

        player.hand.moveCardsTo(cards, selectedPokemon);

        // Height data is not stored on PokemonCard in the engine; opponent self-adjudicates
        // whether their pre-reveal guess was correct.
        store.prompt(state, new SelectPrompt(
          opponent.id,
          GameMessage.CHOOSE_OPTION,
          ['Guessed right', 'Guessed wrong'],
          { allowCancel: false }
        ), choice => {
          const opponentGuessedRight = choice === 0;

          store.prompt(state, new ShowCardsPrompt(
            opponent.id,
            GameMessage.CARDS_SHOWED_BY_THE_OPPONENT,
            selectedPokemon.cards
          ), () => {
            if (opponentGuessedRight) {
              DRAW_CARDS(opponent, 3);
            } else {
              DRAW_CARDS(player, 3);
            }

            selectedPokemon.moveTo(player.hand);
            player.supporter.moveCardTo(effect.trainerCard, player.discard);
          });
        });
      });
    }

    return state;
  }
}

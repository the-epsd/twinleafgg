// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, StateUtils } from '../../game';
import { DealDamageEffect } from '../../game/store/effects/attack-effects';
import { Effect } from '../../game/store/effects/effect';
import { WAS_ATTACK_USED, IS_ABILITY_BLOCKED } from '../../game/store/prefabs/prefabs';
import { DISCARD_AN_ENERGY_FROM_OPPONENTS_ACTIVE_POKEMON } from '../../game/store/prefabs/attack-effects';

export class Tyrantrum extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Tyrunt';
  public cardType: CardType = F;
  public hp: number = 160;
  public weakness = [{ type: G }];
  public retreat = [C, C, C];

  public powers = [{
    name: 'Tyrannical Heart',
    powerType: PowerType.ABILITY,
    text: 'As long as you don\'t have more Pokémon in play than your opponent, this Pokémon\'s attacks do 60 more damage (before applying Weakness and Resistance), and it takes 30 less damage from attacks (after applying Weakness and Resistance).'
  }];

  public attacks = [
    {
      name: 'Crunch',
      cost: [F, F, C],
      damage: 100,
      text: 'Discard an Energy from your opponent\'s Active Pokémon.'
    }
  ];

  public set: string = 'FLI';
  public setNumber: string = '69';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Tyrantrum';
  public fullName: string = 'Tyrantrum FLI';

  private countPokemonInPlay(player: any): number {
    let count = 1; // active
    player.bench.forEach((b: any) => { if (b.cards.length > 0) count++; });
    return count;
  }

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Tyrannical Heart (passive - damage boost + damage reduction)
    // Refs: set-crimson-invasion/kommo-o.ts (War Cry - pokemon count), set-crimson-invasion/kommo-o.ts (Clanging Scales - take more damage)

    // Attack damage boost: intercept this Pokemon's attacks
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      if (!IS_ABILITY_BLOCKED(store, state, player, this)) {
        const myCount = this.countPokemonInPlay(player);
        const oppCount = this.countPokemonInPlay(opponent);

        if (myCount <= oppCount) {
          effect.damage += 60;
        }
      }

      // Attack 1: Crunch
      // Ref: AGENTS-patterns.md (discard energy from opponent)
      DISCARD_AN_ENERGY_FROM_OPPONENTS_ACTIVE_POKEMON(store, state, effect);
    }

    // Damage reduction: intercept damage done to this Pokemon
    // Ref: set-crimson-invasion/kommo-o.ts (DealDamageEffect interception)
    if (effect instanceof DealDamageEffect && effect.target.cards.includes(this) && effect.target.getPokemonCard() === this) {
      const player = StateUtils.findOwner(state, effect.target);
      const opponent = StateUtils.getOpponent(state, player);

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        return state;
      }

      const myCount = this.countPokemonInPlay(player);
      const oppCount = this.countPokemonInPlay(opponent);

      if (myCount <= oppCount) {
        effect.damage = Math.max(0, effect.damage - 30);
      }
    }

    return state;
  }
}

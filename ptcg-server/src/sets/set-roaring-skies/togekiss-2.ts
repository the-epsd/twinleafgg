// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, EnergyType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, GameMessage, ConfirmPrompt } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { PowerEffect } from '../../game/store/effects/game-effects';
import { JUST_EVOLVED, ABILITY_USED, IS_ABILITY_BLOCKED, LOOK_AT_TOP_X_CARDS_AND_ATTACH_UP_TO_Y_ENERGY } from '../../game/store/prefabs/prefabs';

export class Togekiss2 extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Togetic';
  public cardType: CardType = Y;
  public hp: number = 130;
  public weakness = [{ type: M }];
  public resistance = [{ type: D, value: -20 }];
  public retreat = [C];

  public powers = [{
    name: 'Serene Grace',
    powerType: PowerType.ABILITY,
    text: 'When you play this Pokémon from your hand to evolve 1 of your Pokémon, you may look at the top 8 cards of your deck. Choose any basic Energy cards you find there and attach them to your Pokémon in any way you like. Shuffle the other cards back into your deck.'
  }];

  public attacks = [
    {
      name: 'Fairy Wind',
      cost: [Y, C, C],
      damage: 60,
      text: ''
    }
  ];

  public set: string = 'ROS';
  public setNumber: string = '46';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Togekiss';
  public fullName: string = 'Togekiss ROS 46';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Serene Grace (on-evolve trigger)
    // Ref: set-temporal-forces/metang.ts (Metal Maker - look at top cards and attach energy)
    if (JUST_EVOLVED(effect, this)) {
      const player = effect.player;

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        return state;
      }

      store.prompt(state, new ConfirmPrompt(
        player.id,
        GameMessage.WANT_TO_USE_ABILITY
      ), wantToUse => {
        if (!wantToUse) {
          return;
        }

        // Check ability blocked again (in case of timing)
        try {
          const stub = new PowerEffect(player, this.powers[0], this);
          store.reduceEffect(state, stub);
        } catch {
          return;
        }

        ABILITY_USED(player, this);

        LOOK_AT_TOP_X_CARDS_AND_ATTACH_UP_TO_Y_ENERGY(
          store,
          state,
          player,
          8,
          8,
          {
            validCardTypes: undefined,
            remainderDestination: 'shuffle',
            energyFilter: { energyType: EnergyType.BASIC }
          }
        );
      });
    }

    return state;
  }
}

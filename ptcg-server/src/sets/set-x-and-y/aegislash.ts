// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, SuperType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, GameError, GameMessage, PlayerType } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { ChooseCardsPrompt } from '../../game/store/prompts/choose-cards-prompt';
import { WAS_ATTACK_USED, WAS_POWER_USED, USE_ABILITY_ONCE_PER_TURN, ABILITY_USED, REMOVE_MARKER_AT_END_OF_TURN } from '../../game/store/prefabs/prefabs';

export class Aegislash extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Doublade';
  public cardType: CardType = M;
  public hp: number = 140;
  public weakness = [{ type: R }];
  public resistance = [{ type: P, value: -20 }];
  public retreat = [C, C, C];

  public powers = [  {
    name: 'Stance Change',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'Once during your turn (before your attack), you may switch this Pokémon with an Aegislash in your hand. (Any cards attached to this Pokémon, damage counters, Special Conditions, turns in play, and any other effects remain on the new Pokémon.)'
  }];

  public attacks = [
    {
      name: 'Buster Swing',
      cost: [M, M, C, C],
      damage: 120,
      text: 'This attack\'s damage isn\'t affected by Resistance.'
    }
  ];

  public set: string = 'XY';
  public setNumber: string = '85';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Aegislash';
  public fullName: string = 'Aegislash XY';

  public readonly STANCE_CHANGE_MARKER = 'AEGISLASH_XY_STANCE_CHANGE_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Stance Change
    // Ref: set-x-and-y/swellow.ts (Drive Off - once per turn ability pattern)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;

      // Check if there's an Aegislash in hand (different card instance)
      const aegislashInHand = player.hand.cards.filter(
        c => c instanceof PokemonCard && c.name === 'Aegislash' && c !== this
      );

      if (aegislashInHand.length === 0) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      USE_ABILITY_ONCE_PER_TURN(player, this.STANCE_CHANGE_MARKER, this);
      ABILITY_USED(player, this);

      // Find this card in the player's Pokemon slots
      let cardList: any = null;
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (list) => {
        if (list.cards.includes(this)) {
          cardList = list;
        }
      });

      if (cardList === null) {
        return state;
      }

      // Block non-Aegislash cards in hand
      const blocked: number[] = [];
      player.hand.cards.forEach((card, index) => {
        if (!(card instanceof PokemonCard) || card.name !== 'Aegislash') {
          blocked.push(index);
        }
      });

      store.prompt(state, new ChooseCardsPrompt(
        player,
        GameMessage.CHOOSE_CARD_TO_HAND,
        player.hand,
        { superType: SuperType.POKEMON },
        { min: 1, max: 1, allowCancel: false, blocked }
      ), selected => {
        if (!selected || selected.length === 0) {
          return;
        }

        const newAegislash = selected[0] as PokemonCard;

        // Swap: remove this card from the PokemonCardList, insert new one
        const thisIndex = cardList.cards.indexOf(this);
        if (thisIndex !== -1) {
          // Remove this from the card list
          cardList.cards.splice(thisIndex, 1);
          // Remove from hand
          const handIndex = player.hand.cards.indexOf(newAegislash);
          if (handIndex !== -1) {
            player.hand.cards.splice(handIndex, 1);
          }
          // Insert new Aegislash at the same position
          cardList.cards.splice(thisIndex, 0, newAegislash);
          // Put old Aegislash into hand
          player.hand.cards.push(this);
        }
      });
    }

    REMOVE_MARKER_AT_END_OF_TURN(effect, this.STANCE_CHANGE_MARKER, this);

    // Attack 1: Buster Swing
    // Ref: set-plasma-blast/machamp.ts (Buster Swing - ignoreResistance)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      effect.ignoreResistance = true;
    }

    return state;
  }
}

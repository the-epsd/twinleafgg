// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { PlayerType, StateUtils, StoreLike, State } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { AddSpecialConditionsEffect, DealDamageEffect, PutDamageEffect } from '../../game/store/effects/attack-effects';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { WAS_ATTACK_USED, MULTIPLE_COIN_FLIPS_PROMPT } from '../../game/store/prefabs/prefabs';
import { YOUR_OPPPONENTS_ACTIVE_POKEMON_IS_NOW_POISIONED } from '../../game/store/prefabs/attack-effects';

export class Beedrill extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Kakuna';
  public cardType: CardType = G;
  public hp: number = 120;
  public weakness = [{ type: R }];
  public retreat = [C];

  public attacks = [
    {
      name: 'Poison Jab',
      cost: [G],
      damage: 20,
      text: 'Your opponent\'s Active Pokémon is now Poisoned.'
    },
    {
      name: 'Flash Needle',
      cost: [G, G],
      damage: 40,
      damageCalculation: 'x' as 'x',
      text: 'Flip 3 coins. This attack does 40 damage times the number of heads. If all of them are heads, prevent all effects of attacks, including damage, done to this Pokémon during your opponent\'s next turn.'
    }
  ];

  public set: string = 'XY';
  public setNumber: string = '5';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Beedrill';
  public fullName: string = 'Beedrill XY';

  private readonly PREVENT_ALL_DAMAGE_AND_EFFECTS_MARKER = 'BEEDRILL_PREVENT_ALL_DAMAGE_AND_EFFECTS_MARKER';
  private readonly CLEAR_PREVENT_ALL_MARKER = 'BEEDRILL_CLEAR_PREVENT_ALL_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Poison Jab
    // Ref: AGENTS-patterns.md (Poisoned status condition)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      YOUR_OPPPONENTS_ACTIVE_POKEMON_IS_NOW_POISIONED(store, state, effect);
    }

    // Attack 2: Flash Needle
    // Refs: set-plasma-freeze/noctowl.ts (Fly - coin flip + prevent all effects marker), CLAUDE-prefabs.md (MULTIPLE_COIN_FLIPS_PROMPT)
    if (WAS_ATTACK_USED(effect, 1, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      MULTIPLE_COIN_FLIPS_PROMPT(store, state, player, 3, results => {
        const heads = results.filter(r => r).length;
        effect.damage = 40 * heads;

        if (heads === 3) {
          player.active.marker.addMarker(this.PREVENT_ALL_DAMAGE_AND_EFFECTS_MARKER, this);
          opponent.marker.addMarker(this.CLEAR_PREVENT_ALL_MARKER, this);
        }
      });
    }

    // Prevent all effects of attacks, including damage, done to this Pokemon
    if ((effect instanceof PutDamageEffect || effect instanceof DealDamageEffect || effect instanceof AddSpecialConditionsEffect)
      && effect.target.cards.includes(this)
      && effect.target.marker.hasMarker(this.PREVENT_ALL_DAMAGE_AND_EFFECTS_MARKER, this)) {
      effect.preventDefault = true;
      return state;
    }

    // Clean up markers at end of opponent's turn
    if (effect instanceof EndTurnEffect && effect.player.marker.hasMarker(this.CLEAR_PREVENT_ALL_MARKER, this)) {
      effect.player.marker.removeMarker(this.CLEAR_PREVENT_ALL_MARKER, this);
      const opponent = StateUtils.getOpponent(state, effect.player);
      opponent.forEachPokemon(PlayerType.TOP_PLAYER, (cardList) => {
        cardList.marker.removeMarker(this.PREVENT_ALL_DAMAGE_AND_EFFECTS_MARKER, this);
      });
    }

    return state;
  }
}

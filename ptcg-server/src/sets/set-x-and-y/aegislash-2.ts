// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, SuperType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, GameError, GameMessage, PlayerType, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { DealDamageEffect, PutDamageEffect } from '../../game/store/effects/attack-effects';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { ChooseCardsPrompt } from '../../game/store/prompts/choose-cards-prompt';
import { WAS_ATTACK_USED, WAS_POWER_USED, USE_ABILITY_ONCE_PER_TURN, ABILITY_USED, REMOVE_MARKER_AT_END_OF_TURN, THIS_POKEMON_CANNOT_USE_THIS_ATTACK_NEXT_TURN } from '../../game/store/prefabs/prefabs';

export class Aegislash2 extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Doublade';
  public cardType: CardType = M;
  public hp: number = 140;
  public weakness = [{ type: R }];
  public resistance = [{ type: P, value: -20 }];
  public retreat = [C, C, C];

  public powers = [  {
    name: 'Stance Change',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'Once during your turn (before your attack), you may switch this Pokémon with an Aegislash in your hand. (Any cards attached to this Pokémon, damage counters, Special Conditions, turns in play, and any other effects remain on the new Pokémon.)'
  }];

  public attacks = [
    {
      name: 'King\'s Shield',
      cost: [M, M, C, C],
      damage: 50,
      text: 'Prevent all damage done to this Pokémon by attacks during your opponent\'s next turn. This Pokémon can\'t use King\'s Shield during your next turn.'
    }
  ];

  public set: string = 'XY';
  public setNumber: string = '86';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Aegislash';
  public fullName: string = 'Aegislash XY 86';

  public readonly STANCE_CHANGE_MARKER = 'AEGISLASH2_XY_STANCE_CHANGE_MARKER';
  private readonly PREVENT_DAMAGE_MARKER = 'AEGISLASH2_PREVENT_DAMAGE_MARKER';
  private readonly CLEAR_PREVENT_DAMAGE_MARKER = 'AEGISLASH2_CLEAR_PREVENT_DAMAGE_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Stance Change
    // Ref: set-x-and-y/aegislash.ts (Stance Change)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;

      // Check if there's an Aegislash in hand (different card instance)
      const aegislashInHand = player.hand.cards.filter(
        c => c instanceof PokemonCard && c.name === 'Aegislash' && c !== this
      );

      if (aegislashInHand.length === 0) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      USE_ABILITY_ONCE_PER_TURN(player, this.STANCE_CHANGE_MARKER, this);
      ABILITY_USED(player, this);

      // Find this card in the player's Pokemon slots
      let cardList: any = null;
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (list) => {
        if (list.cards.includes(this)) {
          cardList = list;
        }
      });

      if (cardList === null) {
        return state;
      }

      // Block non-Aegislash cards in hand
      const blocked: number[] = [];
      player.hand.cards.forEach((card, index) => {
        if (!(card instanceof PokemonCard) || card.name !== 'Aegislash') {
          blocked.push(index);
        }
      });

      store.prompt(state, new ChooseCardsPrompt(
        player,
        GameMessage.CHOOSE_CARD_TO_HAND,
        player.hand,
        { superType: SuperType.POKEMON },
        { min: 1, max: 1, allowCancel: false, blocked }
      ), selected => {
        if (!selected || selected.length === 0) {
          return;
        }

        const newAegislash = selected[0] as PokemonCard;

        // Swap: remove this card from the PokemonCardList, insert new one
        const thisIndex = cardList.cards.indexOf(this);
        if (thisIndex !== -1) {
          // Remove this from the card list
          cardList.cards.splice(thisIndex, 1);
          // Remove from hand
          const handIndex = player.hand.cards.indexOf(newAegislash);
          if (handIndex !== -1) {
            player.hand.cards.splice(handIndex, 1);
          }
          // Insert new Aegislash at the same position
          cardList.cards.splice(thisIndex, 0, newAegislash);
          // Put old Aegislash into hand
          player.hand.cards.push(this);
        }
      });
    }

    REMOVE_MARKER_AT_END_OF_TURN(effect, this.STANCE_CHANGE_MARKER, this);

    // Attack 1: King's Shield
    // Refs: set-plasma-freeze/noctowl.ts (prevent all damage pattern), set-dragons-exalted/wailord.ts (can't use attack next turn)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      // Prevent all damage during opponent's next turn
      player.active.marker.addMarker(this.PREVENT_DAMAGE_MARKER, this);
      opponent.marker.addMarker(this.CLEAR_PREVENT_DAMAGE_MARKER, this);

      // Can't use King's Shield during your next turn
      THIS_POKEMON_CANNOT_USE_THIS_ATTACK_NEXT_TURN(player, this.attacks[0]);
    }

    // Prevent all damage done to this Pokemon by attacks
    if ((effect instanceof PutDamageEffect || effect instanceof DealDamageEffect)
      && effect.target.cards.includes(this)
      && effect.target.marker.hasMarker(this.PREVENT_DAMAGE_MARKER, this)) {
      effect.preventDefault = true;
      return state;
    }

    // Cleanup at end of opponent's turn
    if (effect instanceof EndTurnEffect && effect.player.marker.hasMarker(this.CLEAR_PREVENT_DAMAGE_MARKER, this)) {
      effect.player.marker.removeMarker(this.CLEAR_PREVENT_DAMAGE_MARKER, this);
      const opponent = StateUtils.getOpponent(state, effect.player);
      opponent.forEachPokemon(PlayerType.TOP_PLAYER, (cardList) => {
        cardList.marker.removeMarker(this.PREVENT_DAMAGE_MARKER, this);
      });
    }

    return state;
  }
}

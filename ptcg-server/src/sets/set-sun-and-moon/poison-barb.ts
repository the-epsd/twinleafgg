// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { TrainerType, SpecialCondition } from '../../game/store/card/card-types';
import { StoreLike, State, StateUtils, GamePhase } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { AfterDamageEffect } from '../../game/store/effects/attack-effects';
import { ToolEffect } from '../../game/store/effects/play-card-effects';
import { AddSpecialConditionsPowerEffect } from '../../game/store/effects/check-effects';

export class PoisonBarb extends TrainerCard {
  public trainerType: TrainerType = TrainerType.TOOL;
  public set: string = 'SUM';
  public setNumber: string = '124';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Poison Barb';
  public fullName: string = 'Poison Barb SUM';
  public text: string = 'If the Pokémon this card is attached to is your Active Pokémon and is damaged by an opponent\'s attack (even if this Pokémon is Knocked Out), the Attacking Pokémon is now Poisoned.';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ref: set-scarlet-and-violet/rocky-helmet.ts (Rocky Helmet - tool damage after attack)
    if (effect instanceof AfterDamageEffect && effect.target.tools.includes(this)) {
      const player = effect.player;
      const targetPlayer = StateUtils.findOwner(state, effect.target);

      // Only trigger if: attacked by opponent, target is active, damage > 0
      if (effect.damage <= 0 || player === targetPlayer || targetPlayer.active !== effect.target) {
        return state;
      }

      // Check if tool is blocked
      try {
        const stub = new ToolEffect(effect.player, this);
        store.reduceEffect(state, stub);
      } catch {
        return state;
      }

      if (state.phase === GamePhase.ATTACK) {
        // Poison the attacking Pokemon
        const poisonEffect = new AddSpecialConditionsPowerEffect(player, this, effect.source, [SpecialCondition.POISONED]);
        store.reduceEffect(state, poisonEffect);
      }
    }

    return state;
  }
}

// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { PlayerType, StoreLike, State, StateUtils, GamePhase } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { AfterDamageEffect } from '../../game/store/effects/attack-effects';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { WAS_ATTACK_USED } from '../../game/store/prefabs/prefabs';

export class Bastiodon extends PokemonCard {
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Shieldon';
  public cardType: CardType = M;
  public hp: number = 150;
  public weakness = [{ type: R }];
  public resistance = [{ type: P, value: -20 }];
  public retreat = [C, C, C, C];

  public attacks = [
    {
      name: 'Counter Head',
      cost: [C, C],
      damage: 0,
      text: 'During your opponent\'s next turn, if this Pokémon is damaged by an attack (even if this Pokémon is Knocked Out), put damage counters on the Attacking Pokémon equal to the damage done to this Pokémon.'
    },
    {
      name: 'Fortress of Rage',
      cost: [M, M, C, C],
      damage: 100,
      damageCalculation: '+' as '+',
      text: 'This attack does 10 more damage for each of your Benched Pokémon that has any damage counters on it.'
    }
  ];

  public set: string = 'STS';
  public setNumber: string = '70';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Bastiodon';
  public fullName: string = 'Bastiodon STS';

  public readonly COUNTER_HEAD_MARKER = 'COUNTER_HEAD_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Counter Head
    // Refs: set-noble-victories/druddigon.ts (AfterDamageEffect retaliation), set-ancient-origins/dangerous-energy.ts (damage reflection)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      player.active.marker.addMarker(this.COUNTER_HEAD_MARKER, this);
    }

    // Counter Head: reflect damage back to attacker
    if (effect instanceof AfterDamageEffect && effect.target.cards.includes(this)) {
      if (effect.target.marker.hasMarker(this.COUNTER_HEAD_MARKER, this)) {
        const targetPlayer = StateUtils.findOwner(state, effect.target);
        const attackingPlayer = effect.player;

        if (effect.damage > 0 && attackingPlayer !== targetPlayer
          && targetPlayer.active === effect.target
          && state.phase === GamePhase.ATTACK) {
          effect.source.damage += effect.damage;
        }
      }
    }

    // Clean up marker at end of opponent's turn
    if (effect instanceof EndTurnEffect) {
      effect.player.forEachPokemon(PlayerType.BOTTOM_PLAYER, cardList => {
        cardList.marker.removeMarker(this.COUNTER_HEAD_MARKER, this);
      });
    }

    // Attack 2: Fortress of Rage
    // Ref: set-plasma-storm/beartic.ts (damage counters counting)
    if (WAS_ATTACK_USED(effect, 1, this)) {
      const player = effect.player;
      let damagedBenchCount = 0;
      player.bench.forEach(benched => {
        if (benched.cards.length > 0 && benched.damage > 0) {
          damagedBenchCount++;
        }
      });
      effect.damage += 10 * damagedBenchCount;
    }

    return state;
  }
}

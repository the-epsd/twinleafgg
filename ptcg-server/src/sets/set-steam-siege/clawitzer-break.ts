// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag } from '../../game/store/card/card-types';
import { PlayerType, StoreLike, State, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { DealDamageEffect } from '../../game/store/effects/attack-effects';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import {
  WAS_ATTACK_USED, BLOCK_RETREAT, BLOCK_RETREAT_IF_MARKER,
  REMOVE_MARKER_FROM_ACTIVE_AT_END_OF_TURN, REPLACE_MARKER_AT_END_OF_TURN
} from '../../game/store/prefabs/prefabs';
import { MarkerConstants } from '../../game/store/markers/marker-constants';

export class ClawitzerBreak extends PokemonCard {
  public tags = [CardTag.BREAK];
  public stage: Stage = Stage.BREAK;
  public evolvesFrom: string = 'Clawitzer';
  public cardType: CardType = W;
  public hp: number = 130;
  public retreat = [];

  public attacks = [
    {
      name: 'Lock-On',
      cost: [C],
      damage: 0,
      text: 'The Defending Pokémon can\'t retreat during your opponent\'s next turn. During your next turn, any damage done to that Pokémon by attacks is increased by 120 (after applying Weakness and Resistance).'
    }
  ];

  public set: string = 'STS';
  public setNumber: string = '35';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Clawitzer BREAK';
  public fullName: string = 'Clawitzer BREAK STS';

  public readonly LOCK_ON_TARGET_MARKER = 'LOCK_ON_TARGET_MARKER';
  public readonly LOCK_ON_PHASE1_MARKER = 'LOCK_ON_PHASE1_MARKER';
  public readonly LOCK_ON_CLEAR_MARKER = 'LOCK_ON_CLEAR_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Lock-On
    // Refs: set-surging-sparks/vibrava.ts (defending takes more damage), set-noble-victories/druddigon.ts (retreat block)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      // Block retreat during opponent's next turn
      BLOCK_RETREAT(store, state, effect, this);

      // Mark the defending Pokemon as Lock-On target
      opponent.active.marker.addMarker(this.LOCK_ON_TARGET_MARKER, this);

      // 2-phase marker for "during your next turn" timing
      player.marker.addMarker(this.LOCK_ON_PHASE1_MARKER, this);
    }

    // Retreat block helpers
    BLOCK_RETREAT_IF_MARKER(effect, MarkerConstants.DEFENDING_POKEMON_CANNOT_RETREAT_MARKER, this);
    REMOVE_MARKER_FROM_ACTIVE_AT_END_OF_TURN(effect, MarkerConstants.DEFENDING_POKEMON_CANNOT_RETREAT_MARKER, this);

    // Increase damage by 120 to the targeted Pokemon during player's next turn
    if (effect instanceof DealDamageEffect
      && effect.target.marker.hasMarker(this.LOCK_ON_TARGET_MARKER, this)) {
      const attackingPlayer = effect.player;
      // Only increase if the attacker has the clear marker (meaning it's their next turn)
      if (attackingPlayer.marker.hasMarker(this.LOCK_ON_CLEAR_MARKER, this)) {
        effect.damage += 120;
      }
    }

    // Phase transition and cleanup at end of turn
    if (effect instanceof EndTurnEffect) {
      // Phase 1 -> Phase 2 (end of current turn -> now waiting for next turn)
      REPLACE_MARKER_AT_END_OF_TURN(effect, this.LOCK_ON_PHASE1_MARKER, this.LOCK_ON_CLEAR_MARKER, this);

      // Phase 2 -> cleanup (end of next turn)
      if (effect.player.marker.hasMarker(this.LOCK_ON_CLEAR_MARKER, this)) {
        effect.player.marker.removeMarker(this.LOCK_ON_CLEAR_MARKER, this);

        // Remove Lock-On target marker from all of opponent's Pokemon
        const opponent = StateUtils.getOpponent(state, effect.player);
        opponent.forEachPokemon(PlayerType.TOP_PLAYER, cardList => {
          cardList.marker.removeMarker(this.LOCK_ON_TARGET_MARKER, this);
        });
      }
    }

    return state;
  }
}
